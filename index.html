<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Aplikasi Sewa Motor - Lokal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
      :root { --bg:#f6f7fb; --card:#fff; --accent:#2b7a78; }
      body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; background: var(--bg); margin:0; padding:20px; color:#222; }
      .container { max-width:1100px; margin:0 auto; }
      header { display:flex; align-items:center; justify-content:space-between; margin-bottom:18px; }
      h1 { font-size:20px; margin:0; }
      .btn { background:var(--accent); color:#fff; padding:8px 12px; border-radius:8px; text-decoration:none; display:inline-block; cursor:pointer; border:none; }
      .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:18px; }
      .card { background:var(--card); border-radius:12px; padding:12px; box-shadow:0 6px 18px rgba(20,20,60,0.06); }
      .motor-img { height:140px; border-radius:8px; background:linear-gradient(90deg,#e8f8f7,#f0f6ff); display:flex; align-items:center; justify-content:center; font-size:48px; }
      .meta { display:flex; align-items:center; justify-content:space-between; margin-top:10px; }
      .status { padding:6px 8px; border-radius:8px; font-weight:600; }
      .available { background:#e6fff9; color:#007a5f; }
      .rented { background:#fff2f2; color:#b90909; }
      .actions { margin-top:10px; display:flex; gap:8px; }
      .small { font-size:13px; color:#666; }
      .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(10,10,20,0.45); z-index:10; }
      .modal.show { display:flex; }
      .dialog { background:var(--card); padding:18px; border-radius:12px; width:420px; box-shadow:0 20px 60px rgba(10,10,40,0.3); }
      label { display:block; margin-top:10px; font-size:13px; }
      input[type="text"], input[type="tel"], input[type="number"], select { width:100%; padding:8px; border-radius:8px; border:1px solid #ddd; margin-top:6px; }
      .row { display:flex; gap:8px; }
      .muted { color:#666; font-size:13px; }
      table { width:100%; border-collapse:collapse; margin-top:12px; }
      th, td { padding:8px; border-bottom:1px solid #eee; text-align:left; }
      .admin-panel { display:none; margin-top:18px; }
      footer { margin-top:20px; text-align:center; color:#666; }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Aplikasi Sewa Motor (Lokal)</h1>
        <button id="adminBtn" class="btn"><i class="fa-solid fa-lock"></i> Admin</button>
      </header>

      <!-- Grid Motor -->
      <section>
        <p class="small">
          Klik <strong>Sewa</strong> pada motor untuk membuka form pemesanan. Status berubah otomatis setelah sewa.
        </p>
        <div class="grid" id="motorGrid"></div>
      </section>

      <!-- Modal Sewa -->
      <div id="rentModal" class="modal">
        <div class="dialog">
          <h3 id="modalTitle">Form Sewa</h3>
          <form id="rentForm">
            <input type="hidden" id="bikeId" />
            <label>Nama penyewa</label>
            <input id="name" type="text" required />
            <label>No. HP</label>
            <input id="phone" type="tel" pattern="[0-9+ ]*" required />
            <label>Durasi sewa (jam)</label>
            <input id="hours" type="number" min="1" value="1" required />
            <label>Tanggal & Waktu Mulai Sewa</label>
            <input id="startDateTime" type="datetime-local" required />
            <p class="muted" id="endDateTimePreview">Selesai sewa: -</p>
            <label>Ketentuan</label>
            <div class="row">
              <label style="flex:1"><input id="idKtp" type="checkbox" /> Memiliki KTP</label>
              <label style="flex:1"><input id="idStudent" type="checkbox" /> Kartu Mahasiswa</label>
            </div>
            <label>Tarif</label>
            <select id="rateSelect">
              <option value="5000|60000">Standar — Rp 5.000 / jam • Rp 60.000 / 24 jam</option>
              <option value="10000|70000">Premium — Rp 10.000 / jam • Rp 70.000 / 24 jam</option>
            </select>
            <p class="muted" id="pricePreview">Total: Rp 5.000</p>
            <div style="display:flex; gap:8px; margin-top:12px; justify-content:flex-end;">
              <button type="button" id="closeModal" class="btn" style="background:#777">Batal</button>
              <button type="submit" class="btn">Konfirmasi Sewa</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Admin Panel -->
      <div class="admin-panel card" id="adminPanel">
        <h3>Halaman Admin</h3>
        <div style="display:flex; gap:8px; margin-bottom:8px">
          <button id="addBike" class="btn"><i class="fa-solid fa-plus"></i> Tambah Motor</button>
        </div>
      </div>

      <!-- Riwayat Sewa -->
      <div class="card" style="margin-top:18px;">
        <h3>Riwayat Sewa</h3>
        <table id="rentalHistory">
          <thead>
            <tr>
              <th>Motor</th>
              <th>Penyewa</th>
              <th>HP</th>
              <th>Durasi (jam)</th>
              <th>Mulai</th>
              <th>Selesai</th>
              <th>Total (Rp)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <button id="exportPdfBtn" class="btn" style="margin-top:12px;"><i class="fa-solid fa-file-pdf"></i> Export PDF</button>
      </div>

    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
      import { getFirestore, collection, getDocs, addDoc, updateDoc, doc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey:"AIzaSyB5uHlXqwLiAmsUeF4Qawsmv0iNRGRdi3c",
        authDomain:"sewa-motor-ba94a.firebaseapp.com",
        projectId:"sewa-motor-ba94a",
        storageBucket:"sewa-motor-ba94a.appspot.com",
        messagingSenderId:"921374655717",
        appId:"1:921374655717:web:d7b21349675a530045c00c",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      const motorGrid = document.getElementById("motorGrid");
      const rentModal = document.getElementById("rentModal");
      const adminBtn = document.getElementById("adminBtn");
      const adminPanel = document.getElementById("adminPanel");
      const closeModal = document.getElementById("closeModal");
      const rentForm = document.getElementById("rentForm");
      const hoursInput = document.getElementById("hours");
      const startInput = document.getElementById("startDateTime");
      const rateSelect = document.getElementById("rateSelect");
      const endPreview = document.getElementById("endDateTimePreview");
      const pricePreview = document.getElementById("pricePreview");

      const rentalHistoryBody = document.getElementById("rentalHistory").querySelector("tbody");
      const exportPdfBtn = document.getElementById("exportPdfBtn");

      let currentBikeId = null;

      const ADMIN_PASSWORD = "admin123";
      adminBtn.addEventListener("click", () => {
        const pass = prompt("Masukkan password admin:");
        if(pass === ADMIN_PASSWORD){
          adminPanel.style.display = "block";
          alert("Login admin berhasil");
        } else {
          alert("Password salah!");
        }
      });

      const motorCol = collection(db, "motor");

      // Render Motor Card
      const renderMotors = async () => {
        motorGrid.innerHTML = "";
        const querySnapshot = await getDocs(motorCol);
        querySnapshot.forEach(docSnap => {
          const data = docSnap.data();
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <div class="motor-img"><i class="fa-solid fa-motorcycle"></i></div>
            <h4>${data.name}</h4>
            <div class="meta">
              <span class="status ${data.status === "available" ? "available" : "rented"}">${data.status}</span>
              <span class="small">${data.rate24 ? "Rp "+data.rate24+"/24 jam" : ""}</span>
            </div>
            <div class="actions">
              <button class="btn rentBtn" data-id="${docSnap.id}" ${data.status==="rented"?"disabled":""}>Sewa</button>
            </div>
          `;
          motorGrid.appendChild(card);
        });
        attachRentEvents();
      };

      const attachRentEvents = () => {
        document.querySelectorAll(".rentBtn").forEach(btn => {
          btn.addEventListener("click", e => {
            currentBikeId = e.target.dataset.id;
            rentModal.classList.add("show");
          });
        });
      };

      closeModal.addEventListener("click", () => {
        rentModal.classList.remove("show");
        rentForm.reset();
        endPreview.textContent = "Selesai sewa: -";
        pricePreview.textContent = "Total: Rp 0";
      });

      const updatePreview = () => {
        const start = new Date(startInput.value);
        const hours = parseInt(hoursInput.value || 1);
        if(!isNaN(start.getTime())) {
          const end = new Date(start.getTime() + hours*60*60*1000);
          endPreview.textContent = "Selesai sewa: " + end.toLocaleString();
        }
        const rates = rateSelect.value.split("|");
        const total = hours <= 24 ? parseInt(rates[0])*hours : parseInt(rates[1]);
        pricePreview.textContent = "Total: Rp " + total.toLocaleString();
      };

      hoursInput.addEventListener("input", updatePreview);
      startInput.addEventListener("input", updatePreview);
      rateSelect.addEventListener("change", updatePreview);

      // Submit Rent
      rentForm.addEventListener("submit", async e => {
        e.preventDefault();
        if(!currentBikeId) return;
        const name = document.getElementById("name").value;
        const phone = document.getElementById("phone").value;
        const hours = parseInt(hoursInput.value);
        const start = new Date(startInput.value);
        const rates = rateSelect.value.split("|");
        const total = hours <= 24 ? parseInt(rates[0])*hours : parseInt(rates[1]);

        await updateDoc(doc(db, "motor", currentBikeId), {
          status: "rented",
          renter: { name, phone, hours, start: start.toISOString(), total }
        });
        alert("Motor berhasil disewa");
        rentModal.classList.remove("show");
        rentForm.reset();
        renderMotors();
        renderHistory();
      });

      // Render History
      const renderHistory = async () => {
        rentalHistoryBody.innerHTML = "";
        const snapshot = await getDocs(motorCol);
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          if(data.renter){
            const start = new Date(data.renter.start);
            const end = new Date(start.getTime() + data.renter.hours*60*60*1000);
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${data.name}</td>
              <td>${data.renter.name}</td>
              <td>${data.renter.phone}</td>
              <td>${data.renter.hours}</td>
              <td>${start.toLocaleString()}</td>
              <td>${end.toLocaleString()}</td>
              <td>${data.renter.total.toLocaleString()}</td>
            `;
            rentalHistoryBody.appendChild(tr);
          }
        });
      };

      // Export PDF
      exportPdfBtn.addEventListener("click", ()=>{
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("Riwayat Sewa Motor", 10, 10);

        const rows = [];
        rentalHistoryBody.querySelectorAll("tr").forEach(tr=>{
          const cols = Array.from(tr.querySelectorAll("td")).map(td=>td.textContent);
          rows.push(cols);
        });

        doc.autoTable({
          head: [["Motor","Penyewa","HP","Durasi","Mulai","Selesai","Total (Rp)"]],
          body: rows,
          startY: 20
        });
        doc.save("riwayat_sewa.pdf");
      });

      // Real-time updates
      onSnapshot(motorCol, () => {
        renderMotors();
        renderHistory();
      });

      renderMotors();
      renderHistory();
    </script>
  </body>
</html>
