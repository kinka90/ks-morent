<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Aplikasi Sewa Motor - Lokal</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
:root {
  --bg:#f6f7fb;
  --card:#fff;
  --accent:#2b7a78;
}
body {
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
  background: var(--bg);
  margin:0;
  padding:20px;
  color:#222;
}
.container {max-width:1100px;margin:0 auto;}
header {display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;}
h1 {font-size:20px;margin:0;}
.btn {background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;text-decoration:none;display:inline-block;cursor:pointer;border:none;}
.grid {display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:18px;}
.card {background:var(--card);border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(20,20,60,0.06);}
.motor-img {height:140px;border-radius:8px;background:#eef;display:flex;align-items:center;justify-content:center;font-size:48px;overflow:hidden;}
.meta {display:flex;align-items:center;justify-content:space-between;margin-top:10px;}
.status {padding:6px 8px;border-radius:8px;font-weight:600;}
.available {background:#e6fff9;color:#007a5f;}
.rented {background:#fff2f2;color:#b90909;}
.actions {margin-top:10px;display:flex;gap:8px;}
.small {font-size:13px;color:#666;}

img.motor-photo {
  width:100%;
  height:100%;
  object-fit:cover;
  border-radius:8px;
  display:block;
}
</style>
</head>

<body>
<div class="container">

<header>
  <h1>Aplikasi Sewa Motor (Firebase)</h1>
  <div>
    <button id="adminBtn" class="btn"><i class="fa-solid fa-lock"></i> Admin</button>
    <button id="logoutBtn" class="btn" style="background:#777;display:none">Logout</button>
  </div>
</header>

<section>
<p class="small">Klik <strong>Sewa</strong> pada motor untuk membuka form pemesanan.</p>
<div class="grid" id="motorGrid"></div>
</section>

<script type="module">
  // --------------------------
  // Firebase Config
  // --------------------------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
  import {
    getDatabase,
    ref,
    push,
    set,
    onValue,
    update,
    remove
  } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

  import {
    getStorage,
    ref as sRef,
    uploadBytes,
    getDownloadURL
  } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC5Nm7fc-L4ILl1yLqctvBkuiBr78jSzU4",
    authDomain: "app-motor-1f954.firebaseapp.com",
    databaseURL:
      "https://app-motor-1f954-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "app-motor-1f954",
    storageBucket: "app-motor-1f954.appspot.com",
    messagingSenderId: "157881256704",
    appId: "1:157881256704:web:8426ea3bd955a1dbc18064"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const storage = getStorage(app);

  const motorRef = ref(db, "motor");
  const rentalRef = ref(db, "rental");
  const keuanganRef = ref(db, "keuangan");

  // --------------------------
  // TAMBAH MOTOR
  // --------------------------
  const addMotorForm = document.getElementById("addMotorForm");
  const motorImage = document.getElementById("motorImage");

  addMotorForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const nama = document.getElementById("nama").value;
    const plat = document.getElementById("plat").value;
    const harga = document.getElementById("harga").value;

    let imageURL = "";

    // â›” Pastikan file gambar dipilih
    if (motorImage.files.length > 0) {
      const file = motorImage.files[0];
      const ext = file.name.split(".").pop();
      const fileName = `bike_${Date.now()}.${ext}`;
      const storageRef = sRef(storage, "motor/" + fileName);

      await uploadBytes(storageRef, file);
      imageURL = await getDownloadURL(storageRef);
    }

    // Simpan motor
    const pushRef = push(motorRef);
    await set(pushRef, {
      id: pushRef.key,
      nama,
      plat,
      harga,
      image: imageURL,
      status: "ready"
    });

    alert("Motor berhasil ditambahkan!");
    addMotorForm.reset();
    loadMotorAdmin();
    loadMotorHome();
  });


  // -------------------------------------------------
  // RENDER MOTOR DI ADMIN
  // -------------------------------------------------
  function loadMotorAdmin() {
    onValue(motorRef, (snapshot) => {
      const data = snapshot.val();
      const list = document.getElementById("adminMotorList");
      list.innerHTML = "";

      if (!data) return;

      Object.values(data).forEach((m) => {
        list.innerHTML += `
          <div class="admin-card">
            <img src="${m.image}" onerror="this.src='https://via.placeholder.com/150'">
            <div class="info">
              <h3>${m.nama}</h3>
              <p>Plat: ${m.plat}</p>
              <p>Harga: Rp ${m.harga}/hari</p>
              <p>Status: <b>${m.status}</b></p>
            </div>

            <button onclick="hapusMotor('${m.id}')">Hapus</button>
          </div>
        `;
      });
    });
  }

  window.hapusMotor = function (id) {
    const ok = confirm("Hapus motor ini?");
    if (!ok) return;
    remove(ref(db, "motor/" + id));
  };

  // -------------------------------------------------
  // RENDER MOTOR DI HALAMAN HOME (UNTUK DISEWA)
  // -------------------------------------------------
  function loadMotorHome() {
    onValue(motorRef, (snapshot) => {
      const data = snapshot.val();
      const homeList = document.getElementById("homeMotorList");
      homeList.innerHTML = "";

      if (!data) return;

      Object.values(data).forEach((m) => {
        if (m.status !== "ready") return;

        homeList.innerHTML += `
          <div class="card">
            <img src="${m.image}" onerror="this.src='https://via.placeholder.com/150'">
            <h3>${m.nama}</h3>
            <p>Plat: ${m.plat}</p>
            <p>Harga: Rp ${m.harga}/hari</p>
            <button onclick="openSewaForm('${m.id}', '${m.nama}', '${m.harga}')">
              Sewa
            </button>
          </div>
        `;
      });
    });
  }

  // -------------------------------------------------
  // BUKA FORM SEWA
  // -------------------------------------------------
  const sewaForm = document.getElementById("sewaForm");

  window.openSewaForm = function (id, nama, harga) {
    document.getElementById("sewaMotorId").value = id;
    document.getElementById("sewaNamaMotor").innerText = nama;
    document.getElementById("sewaHargaMotor").innerText = harga;
    sewaForm.style.display = "block";
  };

  document.getElementById("closeSewa").onclick = () => {
    sewaForm.style.display = "none";
  };

  // -------------------------------------------------
  // SIMPAN DATA SEWA
  // -------------------------------------------------
  const formSewa = document.getElementById("formSewa");

  formSewa.addEventListener("submit", async (e) => {
    e.preventDefault();

    const motorId = document.getElementById("sewaMotorId").value;
    const penyewa = document.getElementById("penyewa").value;
    const hari = parseInt(document.getElementById("hari").value);

    const motorSnapshot = await (await ref(db, "motor/" + motorId)).get;

    onValue(ref(db, "motor/" + motorId), async (snap2) => {
      const motor = snap2.val();
      if (!motor) return;

      const total = hari * motor.harga;

      const tambah = push(rentalRef);

      await set(tambah, {
        id: tambah.key,
        motorId,
        namaMotor: motor.nama,
        penyewa,
        hari,
        harga: motor.harga,
        total,
        tanggal: new Date().toLocaleString(),
        status: "berjalan"
      });

      await update(ref(db, "motor/" + motorId), {
        status: "disewa"
      });

      alert("Transaksi berhasil disimpan!");

      sewaForm.style.display = "none";
      formSewa.reset();

      loadMotorAdmin();
      loadMotorHome();
      loadRentalAdmin();
    });
  });

  // -------------------------------------------------
  // RENDER RENTAL DI ADMIN
  // -------------------------------------------------
  function loadRentalAdmin() {
    onValue(rentalRef, (snapshot) => {
      const data = snapshot.val();
      const list = document.getElementById("adminRentalList");
      list.innerHTML = "";

      if (!data) return;

      Object.values(data).forEach((r) => {
        list.innerHTML += `
          <div class="rental-card">
            <div class="info">
              <h3>${r.namaMotor}</h3>
              <p>Penyewa: ${r.penyewa}</p>
              <p>Lama: ${r.hari} hari</p>
              <p>Total: Rp ${r.total}</p>
              <p>Tanggal: ${r.tanggal}</p>
              <p>Status: <b>${r.status}</b></p>
            </div>

            ${
              r.status === "berjalan"
                ? `<button onclick="kembalikanMotor('${r.id}', '${r.motorId}', '${r.total}')">
                     Kembalikan
                   </button>`
                : ""
            }
          </div>
        `;
      });
    });
  }

  // -------------------------------------------------
  // PENGEMBALIAN MOTOR
  // -------------------------------------------------
  window.kembalikanMotor = async function (rentalId, motorId, total) {
    const ok = confirm("Konfirmasi motor sudah kembali?");
    if (!ok) return;

    // update rental selesai
    await update(ref(db, "rental/" + rentalId), {
      status: "selesai",
      selesaiPada: new Date().toLocaleString()
    });

    // motor menjadi ready lagi
    await update(ref(db, "motor/" + motorId), {
      status: "ready"
    });

    // catat keuangan
    const hariIni = new Date().toISOString().split("T")[0];
    const pushUang = push(ref(db, "keuangan/" + hariIni));

    await set(pushUang, {
      id: pushUang.key,
      masuk: total,
      waktu: new Date().toLocaleString()
    });

    alert("Motor dikembalikan! Keuangan dicatat.");

    loadMotorAdmin();
    loadRentalAdmin();
    loadMotorHome();
    loadKeuangan();
  };

  // -------------------------------------------------
  // RENDER KEUANGAN
  // -------------------------------------------------
  function loadKeuangan() {
    onValue(keuanganRef, (snapshot) => {
      const data = snapshot.val();
      const list = document.getElementById("keuanganList");
      list.innerHTML = "";

      if (!data) return;

      Object.entries(data).forEach(([tanggal, item]) => {
        let totalHari = 0;

        Object.values(item).forEach((x) => {
          totalHari += parseInt(x.masuk);
        });

        list.innerHTML += `
          <div class="uang-card">
            <h3>${tanggal}</h3>
            <p>Total Pendapatan: <b>Rp ${totalHari}</b></p>
          </div>
        `;
      });
    });
  }

  // -----------------------------------------------
  // Jalankan semua load
  // -----------------------------------------------
  loadMotorAdmin();
  loadMotorHome();
  loadRentalAdmin();
  loadKeuangan();
</script>

</body>
</html>
