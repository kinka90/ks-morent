<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Aplikasi Sewa Motor - Lokal</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--accent:#2b7a78}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      background:var(--bg); margin:0; padding:20px; color:#222}
    .container{max-width:1100px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    .btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;text-decoration:none;display:inline-block;cursor:pointer;border:none}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:18px}
    .card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(20,20,60,0.06)}
    .motor-img{height:140px;border-radius:8px;background:linear-gradient(90deg,#e8f8f7,#f0f6ff);display:flex;align-items:center;justify-content:center;font-size:48px}
    .meta{display:flex;align-items:center;justify-content:space-between;margin-top:10px}
    .status{padding:6px 8px;border-radius:8px;font-weight:600}
    .available{background:#e6fff9;color:#007a5f}
    .rented{background:#fff2f2;color:#b90909}
    .actions{margin-top:10px;display:flex;gap:8px}
    .small{font-size:13px;color:#666}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(10,10,20,0.45);z-index:10}
    .modal.show{display:flex}
    .dialog{background:var(--card);padding:18px;border-radius:12px;width:420px;box-shadow:0 20px 60px rgba(10,10,40,0.3)}
    label{display:block;margin-top:10px;font-size:13px}
    input[type=text],input[type=tel],input[type=number],select{width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;margin-top:6px}
    .row{display:flex;gap:8px}
    .muted{color:#666;font-size:13px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
    .admin-panel{display:none;margin-top:18px}
    footer{margin-top:20px;text-align:center;color:#666}
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>Aplikasi Sewa Motor (Lokal)</h1>
      <button id="adminBtn" class="btn"><i class="fa-solid fa-lock"></i> Admin</button>
    </header>

    <section>
      <p class="small">Klik <strong>Sewa</strong> pada motor untuk membuka form pemesanan. Status berubah otomatis setelah sewa.</p>
      <div class="grid" id="motorGrid"></div>
    </section>

    <!-- Modal Sewa -->
    <div id="rentModal" class="modal">
      <div class="dialog">
        <h3 id="modalTitle">Form Sewa</h3>
        <form id="rentForm">
          <input type="hidden" id="bikeId" />

          <label>Nama penyewa</label>
          <input id="name" type="text" required />

          <label>No. HP</label>
          <input id="phone" type="tel" pattern="[0-9+ ]*" required />

          <label>Durasi sewa (jam)</label>
          <input id="hours" type="number" min="1" value="1" required />

          <label>Tanggal & Waktu Mulai Sewa</label>
          <input id="startDateTime" type="datetime-local" required />
          <p class="muted" id="endDateTimePreview">Selesai sewa: -</p>


          <label>Ketentuan</label>
          <div class="row">
            <label style="flex:1"><input id="idKtp" type="checkbox"/> Memiliki KTP</label>
            <label style="flex:1"><input id="idStudent" type="checkbox"/> Kartu Mahasiswa</label>
          </div>

          <label>Tarif</label>
          <select id="rateSelect">
            <option value="6000|60000">Standar â€” Rp 6.000 / jam â€¢ Rp 60.000 / 24 jam</option>
            <option value="7000|70000">Premium â€” Rp 7.000 / jam â€¢ Rp 70.000 / 24 jam</option>
          </select>

          <p class="muted" id="pricePreview">Total: Rp 6.000</p>

          <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
            <button type="button" id="closeModal" class="btn" style="background:#777">Batal</button>
            <button type="submit" class="btn">Konfirmasi Sewa</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Tambah Motor -->
    <div id="addBikeModal" class="modal">
      <div class="dialog">
        <h3>Tambah Motor Baru</h3>
        <form id="addBikeForm">
          <label>Gambar Motor (opsional)</label>
          <input type="file" id="bikeImageInput" accept="image/*" />

          <label>Nama Motor</label>
          <input type="text" id="bikeNameInput" required />

          <label>Tarif per Jam (Rp)</label>
          <input type="number" id="bikeRateHour" min="1000" required />

          <label>Tarif per Hari (Rp)</label>
          <input type="number" id="bikeRateDay" min="10000" required />

          <label>Emoji / Ikon Motor</label>
          <input type="text" id="bikeEmoji" placeholder="ðŸ›µ atau ðŸï¸" required />

          <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
            <button type="button" id="cancelAddBike" class="btn" style="background:#777">Batal</button>
            <button type="submit" class="btn">Simpan</button>
          </div>
        </form>
      </div>
    </div>



    <!-- Admin Panel -->
    <div class="admin-panel card" id="adminPanel">
      <h3>Halaman Admin</h3>
      <p class="small">Buku kas tersedia dalam format PDF â€” hanya untuk admin.</p>
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <button id="downloadPdf" class="btn"><i class="fa-solid fa-file-pdf"></i> Download Buku Kas (PDF)</button>
        <button id="clearData" class="btn" style="background:#b03"><i class="fa-solid fa-trash"></i> Reset Data</button>
        <button id="addBike" class="btn" style="background:#2b7a78">
          <i class="fa-solid fa-plus"></i> Tambah Motor
        </button>
      </div>

      <h4>Riwayat Sewa</h4>
      <div style="overflow:auto;max-height:320px">
        <table id="rentalTable">
          <thead>
            <tr>
              <th>Nama</th><th>No HP</th><th>Motor</th><th>Durasi</th>
              <th>Tarif</th><th>Total</th><th>Mulai</th><th>Selesai</th><th>Kembalikan</th><th>Status</th><th>Aksi</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <footer>Made for you â€” buka file <strong>index.html</strong> di browser (Chrome/Edge). Data disimpan di localStorage.</footer>
  </div>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>


<script>
  const STORAGE_KEYS = { BIKES: 'sewa_bikes', RENTALS: 'sewa_rentals' };
  let isAdmin = false;

// Kirim pesan WhatsApp (fungsi global)
function kirimWhatsApp(phone, message) {
  let nomor = phone.replace(/^0/, '62').replace(/\D/g, '');
  const url = `https://wa.me/${nomor}?text=${encodeURIComponent(message)}`;
  window.open(url, '_blank');
}


  const sampleBikes = [
    { id: 'bike1', name: 'Motor Bebas A', rateHour:6000, rateDay:60000, status:'available', imageEmoji:'ðŸï¸' },
    { id: 'bike2', name: 'Motor Cepat B', rateHour:7000, rateDay:70000, status:'available', imageEmoji:'ðŸ›µ' },
    { id: 'bike3', name: 'Motor Santai C', rateHour:6000, rateDay:60000, status:'available', imageEmoji:'ðŸï¸' }
  ];

  function loadOrInit(){
    if(!localStorage.getItem(STORAGE_KEYS.BIKES)) localStorage.setItem(STORAGE_KEYS.BIKES, JSON.stringify(sampleBikes));
    if(!localStorage.getItem(STORAGE_KEYS.RENTALS)) localStorage.setItem(STORAGE_KEYS.RENTALS, JSON.stringify([]));
  }
  loadOrInit();

  const motorGrid = document.getElementById('motorGrid');
  function numberWithDots(x){ return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.'); }

  function renderBikes(){
    const bikes = JSON.parse(localStorage.getItem(STORAGE_KEYS.BIKES));
    motorGrid.innerHTML = '';
    bikes.forEach(b=>{
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
      <div class="motor-img">
        ${b.imageUrl ? `<img src="${b.imageUrl}" alt="${b.name}" style="width:100%;height:100%;object-fit:cover;border-radius:8px;">` : b.imageEmoji}
      </div>

      <div style="margin-top:10px"><strong>${b.name}</strong></div>
      <div class="meta">
        <div class="small">Tarif: Rp ${numberWithDots(b.rateHour)}/jam</div>
        <div class="status ${b.status==='available'?'available':'rented'}">${b.status==='available'?'Available':'Disewa'}</div>
      </div>
      <div class="actions">
        <button class="btn rentBtn" data-id="${b.id}" ${b.status!=='available'?'disabled':''}>Sewa</button>
        <button class="btn" style="background:#555" onclick="viewDetails('${b.id}')">Detail</button>
        ${isAdmin ? `
            <button class="btn" style="background:#777" onclick="editBike('${b.id}')"><i class="fa-solid fa-pen"></i></button>
            <button class="btn" style="background:#b03" onclick="deleteBike('${b.id}')"><i class="fa-solid fa-trash"></i></button>
          ` : ''}
      </div>
    `;
      motorGrid.appendChild(card);
    });
  }
  renderBikes();

  const rentModal = document.getElementById('rentModal');
  const rentForm = document.getElementById('rentForm');
  const pricePreview = document.getElementById('pricePreview');

  function openRentModal(id){
    const bikes = JSON.parse(localStorage.getItem(STORAGE_KEYS.BIKES));
    const b = bikes.find(x=>x.id===id);
    document.getElementById('bikeId').value = id;
    document.getElementById('modalTitle').textContent = 'Sewa: '+b.name;
    document.getElementById('rateSelect').value = `${b.rateHour}|${b.rateDay}`;
    document.getElementById('hours').value = 1;
    updatePricePreview();
    rentModal.classList.add('show');
  }

  function closeModal(){ rentModal.classList.remove('show'); rentForm.reset(); }

  function updatePricePreview(){
    const val = document.getElementById('rateSelect').value.split('|');
    const hour = parseInt(val[0]); const day = parseInt(val[1]);
    let h = parseInt(document.getElementById('hours').value||1);
    if(h<1) h=1;
    const days = Math.floor(h/24), rem=h%24;
    const total = days*day + rem*hour;
    pricePreview.textContent = `Total: Rp ${numberWithDots(total)}`;
  }

  document.getElementById('closeModal').addEventListener('click', closeModal);
  document.getElementById('rateSelect').addEventListener('change', updatePricePreview);
  document.getElementById('hours').addEventListener('input', updatePricePreview);

  document.body.addEventListener('click', e=>{
    if(e.target.classList.contains('rentBtn')) openRentModal(e.target.dataset.id);
  });

    // --- Hitung otomatis waktu selesai ---
  function updateEndDateTime() {
    const startInput = document.getElementById('startDateTime');
    const hours = parseInt(document.getElementById('hours').value) || 1;
    const endPreview = document.getElementById('endDateTimePreview');

    if (!startInput.value) {
      endPreview.textContent = 'Selesai sewa: -';
      return;
    }

    const startTime = new Date(startInput.value);
    const endTime = new Date(startTime.getTime() + hours * 60 * 60 * 1000);
    endPreview.textContent = 'Selesai sewa: ' + 
      endTime.toLocaleString('id-ID', { dateStyle: 'short', timeStyle: 'short' });
  }

  // aktifkan fungsi saat durasi atau waktu mulai berubah
  document.getElementById('hours').addEventListener('input', updateEndDateTime);
  document.getElementById('startDateTime').addEventListener('change', updateEndDateTime);


  rentForm.addEventListener('submit', e=>{
    e.preventDefault();
    const bikeId=document.getElementById('bikeId').value;
    const name=document.getElementById('name').value.trim();
    const phone=document.getElementById('phone').value.trim();
    const hours=parseInt(document.getElementById('hours').value);
    const ktp=document.getElementById('idKtp').checked;
    const student=document.getElementById('idStudent').checked;
    if(!ktp&&!student){alert('Harus memiliki KTP atau Kartu Mahasiswa!');return;}




// Update end date/time preview
  function updateEndDateTime() {
  const startInput = document.getElementById('startDateTime');
  const hours = parseInt(document.getElementById('hours').value) || 1;
  const endPreview = document.getElementById('endDateTimePreview');
  if (!startInput.value) {
    endPreview.textContent = 'Selesai sewa: -';
    return;
  }
  const startTime = new Date(startInput.value);
  const endTime = new Date(startTime.getTime() + hours * 60 * 60 * 1000);
  endPreview.textContent = 'Selesai sewa: ' + endTime.toLocaleString('id-ID', { dateStyle: 'short', timeStyle: 'short' });
}
document.getElementById('hours').addEventListener('input', updateEndDateTime);
document.getElementById('startDateTime').addEventListener('change', updateEndDateTime);
  

    // Tambahan keterangan ID
    let idDesc = '';
    if(ktp && student) idDesc = 'KTP & Kartu Mahasiswa';
    else if(ktp) idDesc = 'KTP';
    else if(student) idDesc = 'Kartu Mahasiswa';

    const [rateHour,rateDay]=document.getElementById('rateSelect').value.split('|').map(Number);
    const days=Math.floor(hours/24),rem=hours%24,total=days*rateDay+rem*rateHour;

    const bikes=JSON.parse(localStorage.getItem(STORAGE_KEYS.BIKES));
    const rentals=JSON.parse(localStorage.getItem(STORAGE_KEYS.RENTALS));
    const bike=bikes.find(b=>b.id===bikeId);
    bike.status='rented';
    const startTime = document.getElementById('startDateTime').value;
    const endTime = new Date(new Date(startTime).getTime() + hours * 60 * 60 * 1000).toLocaleString();
    const newR = {
      id: 'r_' + Date.now(),
      bikeId, bikeName: bike.name, name, phone, hours,
      rateHour, rateDay, total,
      date: new Date().toLocaleString('id-ID', { dateStyle: 'short', timeStyle: 'short' }),
      startTime,
      endTime,
      status: 'Disewa',
      idDesc
    };

    rentals.push(newR);
    localStorage.setItem(STORAGE_KEYS.BIKES,JSON.stringify(bikes));
    localStorage.setItem(STORAGE_KEYS.RENTALS,JSON.stringify(rentals));
    renderBikes(); renderRentalTable(); closeModal();

  

// --- Kirim pesan WhatsApp otomatis saat sewa dibuat ---
const pesan = 
  `Halo ${name}, terima kasih telah menyewa *${bike.name}* ðŸ›µ\n\n` +
  `ðŸ“… Mulai: ${new Date(startTime).toLocaleString('id-ID', { dateStyle: 'short', timeStyle: 'short' })}\n` +
  `â± Durasi: ${hours} jam\n` +
  `ðŸ•’ Selesai: ${endTime}\n` +
  `ðŸ’° Total Bayar: Rp ${numberWithDots(total)}\n\n` +
  `Mohon datang sesuai jadwal dan jaga kondisi motor dengan baik.`;
kirimWhatsApp(phone, pesan);



    alert('Sukses! Total bayar: Rp '+numberWithDots(total));
  });



  function viewDetails(id){
    const bikes=JSON.parse(localStorage.getItem(STORAGE_KEYS.BIKES));
    const b=bikes.find(x=>x.id===id);
    alert(`${b.name}\nTarif: Rp ${numberWithDots(b.rateHour)}/jam â€¢ Rp ${numberWithDots(b.rateDay)}/24 jam\nStatus: ${b.status}`);
  }




//==================================================//
  // ---- Render tabel riwayat sewa ----

  function renderRentalTable(){
  const rentals = JSON.parse(localStorage.getItem(STORAGE_KEYS.RENTALS));
  const tbody = document.querySelector('#rentalTable tbody');
  tbody.innerHTML = '';

  rentals.slice().reverse().forEach(r => {
    const tr = document.createElement('tr');
    let actionBtns = `
      <button class="btn" style="background:#777;padding:4px 8px" onclick="editRental('${r.id}')">
        <i class='fa-solid fa-pen'></i>
      </button>
      <button class="btn" style="background:#b03;padding:4px 8px" onclick="deleteRental('${r.id}','${r.bikeId}')">
        <i class='fa-solid fa-trash'></i>
      </button>
    `;


    // Tambahkan tombol "Selesai" jika masih disewa
    if(r.status === 'Disewa'){
      actionBtns = `
        <button class="btn" style="background:#2b7a78;padding:4px 8px" onclick="completeRental('${r.id}','${r.bikeId}')">
          <i class='fa-solid fa-check'></i> Selesai
        </button>
        ${actionBtns}
      `;
    }

    tr.innerHTML = `
    <td>${r.name}</td>
    <td>${r.phone}</td>
    <td>${r.bikeName}</td>
    <td>${r.hours}</td>
    <td>Rp ${numberWithDots(r.rateHour)}/jam</td>
    <td>Rp ${numberWithDots(r.total)}</td>
    <td>${r.startTime ? new Date(r.startTime).toLocaleString('id-ID', { dateStyle: 'short', timeStyle: 'short' }) : '-'}</td>
    <td>${r.endTime ? new Date(r.endTime).toLocaleString('id-ID', { dateStyle: 'short', timeStyle: 'short' }) : '-'}</td>
    <td>${r.returnTime || '-'}</td>   <!-- tampilkan waktu selesai otomatis -->
    <td>${r.status}</td>
    <td>${actionBtns}</td>
  `;


    tbody.appendChild(tr);
  });
}


    function editRental(id){
      const rentals = JSON.parse(localStorage.getItem(STORAGE_KEYS.RENTALS));
      const r = rentals.find(x => x.id === id);
      if(!r) return;

      const newHours = parseInt(prompt('Ubah durasi sewa (jam):', r.hours)) || r.hours;
      const newRate = parseInt(prompt('Ubah tarif per jam (Rp):', r.rateHour)) || r.rateHour;

      // Hitung ulang total
      const days = Math.floor(newHours/24), rem = newHours%24;
      const newTotal = days * r.rateDay + rem * newRate;

      r.hours = newHours;
      r.rateHour = newRate;
      r.total = newTotal;

      // Hitung ulang waktu selesai otomatis
      if (r.startTime) {
        const start = new Date(r.startTime);
        const newEnd = new Date(start.getTime() + newHours * 60 * 60 * 1000);
        r.endTime = newEnd.toISOString();
      }     

      localStorage.setItem(STORAGE_KEYS.RENTALS, JSON.stringify(rentals));
      renderRentalTable();

      const pesanUbah = 
        `Halo ${r.name}, jadwal sewa Anda untuk *${r.bikeName}* telah diperbarui ðŸ›µ\n\n` +
        `Durasi baru: ${r.hours} jam\n` +
        `Waktu selesai: ${new Date(r.endTime).toLocaleString('id-ID', { dateStyle: 'short', timeStyle: 'short' })}\n` +
        `Total baru: Rp ${numberWithDots(r.total)}\n\n` +
        `Terima kasih atas perhatian Anda.`;
      kirimWhatsApp(r.phone, pesanUbah);
      
      alert('Data sewa berhasil diperbarui & pesan WA dikirim.');

    }


 // --- Hapus transaksi tunggal & ubah motor ke available ---
  function deleteRental(id, bikeId) {
    if (!confirm('Hapus transaksi ini?')) return;

    let rentals = JSON.parse(localStorage.getItem(STORAGE_KEYS.RENTALS));
    const rental = rentals.find(r => r.id === id);
    rentals = rentals.filter(r => r.id !== id);
    localStorage.setItem(STORAGE_KEYS.RENTALS, JSON.stringify(rentals));

    // ubah status motor ke available jika motor ini masih "rented"
    const bikes = JSON.parse(localStorage.getItem(STORAGE_KEYS.BIKES));
    const bike = bikes.find(b => b.id === bikeId);
    if (bike) {
      bike.status = 'available';
      localStorage.setItem(STORAGE_KEYS.BIKES, JSON.stringify(bikes));
    }

    renderBikes();
    renderRentalTable();
    alert(`Transaksi untuk ${rental?.bikeName || 'motor'} dihapus. Status motor dikembalikan menjadi Available.`);
  }


  // ---- Tambah motor baru ----
  document.getElementById('addBike').addEventListener('click', () => {
    document.getElementById('addBikeModal').classList.add('show');
  });

  document.getElementById('cancelAddBike').addEventListener('click', () => {
    document.getElementById('addBikeModal').classList.remove('show');
  });


 // ---- Simpan motor baru ----
  document.getElementById('addBikeForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const name = document.getElementById('bikeNameInput').value.trim();
    const rateHour = parseInt(document.getElementById('bikeRateHour').value);
    const rateDay = parseInt(document.getElementById('bikeRateDay').value);
    const emoji = document.getElementById('bikeEmoji').value.trim() || 'ðŸ›µ';
    const file = document.getElementById('bikeImageInput').files[0];

    const bikes = JSON.parse(localStorage.getItem(STORAGE_KEYS.BIKES));

    const newBike = {
      id: 'bike' + Date.now(),
      name,
      rateHour,
      rateDay,
      status: 'available',
      imageEmoji: emoji
    };

    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        newBike.imageUrl = e.target.result;
        bikes.push(newBike);
        localStorage.setItem(STORAGE_KEYS.BIKES, JSON.stringify(bikes));
        renderBikes();
        document.getElementById('addBikeModal').classList.remove('show');
        document.getElementById('addBikeForm').reset();
        alert('Motor baru berhasil ditambahkan!');
      };
      reader.readAsDataURL(file);
    } else {
      bikes.push(newBike);
      localStorage.setItem(STORAGE_KEYS.BIKES, JSON.stringify(bikes));
      renderBikes();
      document.getElementById('addBikeModal').classList.remove('show');
      document.getElementById('addBikeForm').reset();
      alert('Motor baru berhasil ditambahkan!');
    }
  });

  // ---- Hapus Motor ----
  function deleteBike(id) {
    if (!confirm('Yakin ingin menghapus motor ini?')) return;
    let bikes = JSON.parse(localStorage.getItem(STORAGE_KEYS.BIKES));
    bikes = bikes.filter(b => b.id !== id);
    localStorage.setItem(STORAGE_KEYS.BIKES, JSON.stringify(bikes));
    renderBikes();
    alert('Motor berhasil dihapus.');
  }


// ---- Edit / Ganti Gambar Motor ----
  function editBike(id) {
    const bikes = JSON.parse(localStorage.getItem(STORAGE_KEYS.BIKES));
    const bike = bikes.find(b => b.id === id);
    if (!bike) return;

    const newName = prompt('Nama motor baru:', bike.name) || bike.name;
    const newRateHour = parseInt(prompt('Tarif per jam baru:', bike.rateHour)) || bike.rateHour;
    const newRateDay = parseInt(prompt('Tarif per hari baru:', bike.rateDay)) || bike.rateDay;

    // Ganti gambar (opsional)
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = e => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = ev => {
          bike.imageUrl = ev.target.result;
          bike.name = newName;
          bike.rateHour = newRateHour;
          bike.rateDay = newRateDay;
          localStorage.setItem(STORAGE_KEYS.BIKES, JSON.stringify(bikes));
          renderBikes();
          alert('Data motor berhasil diperbarui!');
        };
        reader.readAsDataURL(file);
      } else {
        // tanpa ganti gambar
        bike.name = newName;
        bike.rateHour = newRateHour;
        bike.rateDay = newRateDay;
        localStorage.setItem(STORAGE_KEYS.BIKES, JSON.stringify(bikes));
        renderBikes();
        alert('Data motor diperbarui tanpa mengganti gambar.');
      }
    };
    input.click();
  }

// âœ… Fungsi untuk menyelesaikan sewa
function completeRental(id, bikeId){
  const rentals = JSON.parse(localStorage.getItem(STORAGE_KEYS.RENTALS));
  const bikes = JSON.parse(localStorage.getItem(STORAGE_KEYS.BIKES));
  const r = rentals.find(x => x.id === id);
  const b = bikes.find(x => x.id === bikeId);
  if(!r || !b) return;

  r.status = 'Selesai';
  r.returnTime = new Date().toLocaleString('id-ID', { dateStyle: 'short', timeStyle: 'short' });
  b.status = 'available';

  localStorage.setItem(STORAGE_KEYS.RENTALS, JSON.stringify(rentals));
  localStorage.setItem(STORAGE_KEYS.BIKES, JSON.stringify(bikes));
  renderBikes();
  renderRentalTable();

  // --- kirim pesan WhatsApp penyewa ---
  const pesanSelesai = 
    `Halo ${r.name}, penyewaan *${r.bikeName}* telah selesai âœ…\n\n` +
    `ðŸ“… Mulai: ${new Date(r.startTime).toLocaleString('id-ID', { dateStyle: 'short', timeStyle: 'short' })}\n` +
    `ðŸ•’ Selesai: ${r.returnTime}\n` +
    `ðŸ’° Total: Rp ${numberWithDots(r.total)}\n\n` +
    `Terima kasih telah menggunakan layanan kami! ðŸš€`;
  kirimWhatsApp(r.phone, pesanSelesai);

  alert('Penyewaan telah diselesaikan dan pesan terkirim.');
}

  // ---- Download PDF Buku Kas (Tampilan sama seperti tabel admin) ----

  function formatDateSafe(d) {
  if (!d) return '-';
  const parsed = new Date(d);
  if (isNaN(parsed)) return d; // kalau format bukan ISO, tampilkan string aslinya
  return parsed.toLocaleString('id-ID', { dateStyle: 'short', timeStyle: 'short' });
}
  
document.getElementById('downloadPdf').addEventListener('click', () => {
  const rentals = JSON.parse(localStorage.getItem(STORAGE_KEYS.RENTALS));
  if (!rentals.length) {
    alert('Belum ada data sewa.');
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('l', 'pt', 'a4'); // orientasi landscape agar tabel muat
  const title = 'Buku Kas Sewa Motor - Halaman Admin';
  const dateNow = new Date().toLocaleString('id-ID', { dateStyle: 'full', timeStyle: 'short' });

  doc.setFontSize(14);
  doc.text(title, 40, 40);
  doc.setFontSize(10);
  doc.text(`Dicetak pada: ${dateNow}`, 40, 60);

  const rows = rentals.map(r => [
    r.name,
    r.phone,
    r.bikeName,
    r.hours + ' jam',
    'Rp ' + numberWithDots(r.rateHour) + '/jam',
    'Rp ' + numberWithDots(r.total),
    formatDateSafe(r.startTime),
    formatDateSafe(r.endTime),
    formatDateSafe(r.returnTime),
    r.status
  ]);

  doc.autoTable({
    startY: 80,
    head: [['Nama', 'No HP', 'Motor', 'Durasi', 'Tarif', 'Total', 'Mulai', 'Selesai', 'Kembali', 'Status']],
    body: rows,
    styles: { fontSize: 9, cellPadding: 4 },
    headStyles: { fillColor: [43, 122, 120], textColor: 255 },
    alternateRowStyles: { fillColor: [245, 248, 250] },
  });

  // footer
  const pageHeight = doc.internal.pageSize.height;
  doc.setFontSize(9);
  doc.text('Aplikasi Sewa Motor (Lokal) â€” Data Admin', 40, pageHeight - 30);

  doc.save('BukuKasSewaMotor.pdf');
});


  // --- Reset semua data sewa & kembalikan semua motor ke available ---
  document.getElementById('clearData').addEventListener('click', () => {
    if (!confirm('Yakin ingin menghapus seluruh buku kas dan mengembalikan semua motor ke Available?')) return;

    // kosongkan semua data sewa
    localStorage.setItem(STORAGE_KEYS.RENTALS, JSON.stringify([]));

    // ubah semua motor ke available
    const bikes = JSON.parse(localStorage.getItem(STORAGE_KEYS.BIKES));
    bikes.forEach(b => b.status = 'available');
    localStorage.setItem(STORAGE_KEYS.BIKES, JSON.stringify(bikes));

    renderBikes();
    renderRentalTable();
    adminPanel.style.display = 'block';
    isAdmin = true;
    alert('Semua data sewa dihapus dan semua motor dikembalikan ke status Available.');
  });


</script>

  <!-- Firebase -->

<!-- ============== ADMIN LOGIN (GOOGLE) ================= -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } 
    from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
  import { getFirestore } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

  // --- Konfigurasi Firebase kamu ---
  const firebaseConfig = {
    apiKey: "AIzaSyBQxZvf9Q-rOZfd7GprxT2khiZJgQMyDd8",
    authDomain: "aplikasisewa-6ba48.firebaseapp.com",
    projectId: "aplikasisewa-6ba48",
    storageBucket: "aplikasisewa-6ba48.firebasestorage.app",
    messagingSenderId: "8004088189",
    appId: "1:8004088189:web:84800235fe94bedb869c14",
  };

  // --- Inisialisasi Firebase ---
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();
  getFirestore(app); // nanti bisa dipakai untuk data terpusat

  // --- Elemen UI ---
  const adminBtn = document.getElementById("adminBtn");
  const adminPanel = document.getElementById("adminPanel");

  // --- Perubahan status login ---
  onAuthStateChanged(auth, (user) => {
    if (user) {
      // Sudah login
      localStorage.setItem("adminUser", user.displayName);
      showAdminUI(user);
    } else {
      // Belum login
      localStorage.removeItem("adminUser");
      hideAdminUI();
    }
  });

  // --- Klik tombol admin ---
  adminBtn.addEventListener("click", async () => {
    const user = auth.currentUser;
    if (user) {
      // Logout
      await signOut(auth);
      alert("ðŸ‘‹ Logout berhasil");
      hideAdminUI();
    } else {
      // Login Google
      try {
        const result = await signInWithPopup(auth, provider);
        const user = result.user;
        alert(`âœ… Login sebagai ${user.displayName}`);
        showAdminUI(user);
      } catch (err) {
        console.error("Login gagal:", err);
        alert("Gagal login: " + err.message);
      }
    }
  });

  // --- Fungsi UI ---
  function showAdminUI(user) {
    adminPanel.style.display = "block";
    adminBtn.innerHTML = `<i class="fa-solid fa-user-shield"></i> ${user.displayName} (Logout)`;
    isAdmin = true;
    renderBikes();
    renderRentalTable();
  }

  function hideAdminUI() {
    adminPanel.style.display = "none";
    adminBtn.innerHTML = `<i class="fa-solid fa-lock"></i> Login Admin`;
    isAdmin = false;
    renderBikes();
    renderRentalTable();
  }
</script>


</body>
</html>
